<!DOCTYPE html>
<html>
<head>
  <title>WSRP Check-In</title>
</head>
<body>
  <h2>Checking in...</h2>
  <p id="status">Getting your location...</p>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbxF6ZAxi-9j1Z5x9s3twEbT0uZufdTuny3ThsymwkPGZI37I6eyDXp_rbGlDoth8UQNrg/exec";
    const uid = 'UID-' + Math.random().toString(36).substring(2, 10);
    const schoolLat = 42.06099;
    const schoolLng = -87.94404;
    const maxDistanceMeters = 100;

    function toRad(deg) {
      return deg * Math.PI / 180;
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function submitCheckIn(uid, lat, lng) {
      const formData = new FormData();
      formData.append("uid", uid);
      formData.append("latitude", lat);
      formData.append("longitude", lng);

      fetch(webAppUrl, {
        method: "POST",
        body: formData,
      })
      .then(response => response.text())
      .then(text => {
        document.getElementById("status").textContent = text;
      })
      .catch(error => {
        document.getElementById("status").textContent = "❌ Error: " + error.message;
      });
    }

    navigator.geolocation.getCurrentPosition(position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const distance = haversine(lat, lng, schoolLat, schoolLng);

      if (distance <= maxDistanceMeters) {
        document.getElementById("status").textContent = "Submitting check-in...";
        submitCheckIn(uid, lat.toFixed(6), lng.toFixed(6));
      } else {
        document.getElementById("status").textContent = "❌ You are not on school grounds.";
      }
    }, error => {
      document.getElementById("status").textContent = "❌ Location error.";
    });
  </script>
</body>
</html>
