<!DOCTYPE html>
<html>
<head>
  <title>WildStang Robotics Program Check-In</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 2em;
    }
    .spinner {
      margin: 20px auto;
      width: 40px;
      height: 40px;
      border: 5px solid #ccc;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #status {
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <h2>WildStang Robotics Program Check-In</h2>
  <p id="status">üìç Do you want to check in to the WildStang Robotics Program Shop?<br><br>
    <button onclick="startCheckIn()">OK</button></p>
  <div class="spinner" id="spinner" style="display:none;"></div>

  <script>
    const uid = 'UID-' + Math.random().toString(36).substring(2, 10);
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbxF6ZAxi-9j1Z5x9s3twEbT0uZufdTuny3ThsymwkPGZI37I6eyDXp_rbGlDoth8UQNrg/exec';

    const targetLat = 42.060831;
    const targetLng = -87.944095;
    const maxDistanceMeters = 150;

    function toRad(deg) {
      return deg * Math.PI / 180;
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function startCheckIn() {
      document.getElementById('status').textContent = 'üì° Checking location...';
      document.getElementById('spinner').style.display = 'block';

      if (!navigator.geolocation) {
        document.getElementById('status').textContent = '‚ùå Geolocation not supported.';
        document.getElementById('spinner').style.display = 'none';
        return;
      }

      navigator.geolocation.getCurrentPosition(
        position => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const distance = haversine(lat, lng, targetLat, targetLng);

          if (distance <= maxDistanceMeters) {
            document.getElementById('status').textContent = '‚úÖ Location verified. Submitting check-in...';
            submitCheckIn(uid, lat.toFixed(6), lng.toFixed(6));
          } else {
            document.getElementById('status').innerHTML = 
              '‚ùå You need to be <strong>at the WildStang Shop</strong> to clock in or out.<br>' +
              'Current distance: ' + Math.round(distance) + ' meters.';
            document.getElementById('spinner').style.display = 'none';
          }
        },
        error => {
          document.getElementById('status').textContent = '‚ùå Location access denied or unavailable.';
          document.getElementById('spinner').style.display = 'none';
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function submitCheckIn(uid, lat, lng) {
      const formData = new FormData();
      formData.append('uid', uid);
      formData.append('latitude', lat);
      formData.append('longitude', lng);

      fetch(webAppUrl, {
        method: 'POST',
        body: formData
      })
      .then(response => response.text())
      .then(html => {
        document.open();
        document.write(html);
        document.close();
      })
      .catch(err => {
        document.getElementById('spinner').style.display = 'none';
        document.getElementById('status').textContent = '‚ùå Error: ' + err.message;
      });
    }
  </script>
</body>
</html>
